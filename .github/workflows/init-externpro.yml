name: Init externpro
env:
  XPRO_SUBMODULE_PATH: .devcontainer
  XPRO_BUILD_CONTAINER: rocky9-gcc13
on:
  workflow_call:
    secrets:
      automation_token:
        description: 'Token used for automation (push/PR/labels; may need workflow permission when updating workflows).'
        required: true
jobs:
  externpro:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      packages: write
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0   # fetches all history
          fetch-tags: true # explicitly fetches tags
          submodules: true
          token: ${{ github.token }}
      -
        name: Validate externpro submodule
        id: validate
        uses: ./.devcontainer/.github/actions/externpro-validate
        with:
          submodule_path: ${{ env.XPRO_SUBMODULE_PATH }}
      -
        name: Configure Git
        uses: ./.devcontainer/.github/actions/git-configure-bot
        with:
          submodule_path: ${{ steps.validate.outputs.submodule_path }}
      -
        name: Create branch
        id: branch
        run: |
          set -euo pipefail
          UNIQUE_SUFFIX="${{ github.run_id }}-${{ github.run_attempt }}"
          BRANCH_NAME="xpinit-${UNIQUE_SUFFIX}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      -
        name: Add docker-compose links
        id: docker_compose
        shell: bash
        run: |
          set -euo pipefail
          ln -sf .devcontainer/compose.pro.sh docker-compose.sh
          ln -sf .devcontainer/compose.bld.yml docker-compose.yml
          git add docker-compose.sh docker-compose.yml
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "add docker-compose links" -- docker-compose.sh docker-compose.yml
          echo "committed=true" >> "$GITHUB_OUTPUT"
      -
        name: Add CMakePresets
        id: cmake_presets
        shell: bash
        run: |
          set -euo pipefail
          cp -f .devcontainer/cmake/presets/CMakePresets* .
          git add CMakePresets*
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "add CMakePresets" -- CMakePresets*
          echo "committed=true" >> "$GITHUB_OUTPUT"
      -
        name: Add GitHub Actions workflows
        id: gha_workflows
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .github/workflows
          cp -f .devcontainer/.github/wf-templates/xp*.yml .github/workflows/
          git add .github/workflows
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "add GitHub Actions workflows" -- .github/workflows
          echo "committed=true" >> "$GITHUB_OUTPUT"
      -
        name: Create release-tag intent (if missing)
        id: release_intent
        uses: ./.devcontainer/.github/actions/release-tag-intent
      -
        name: Commit release-tag intent
        id: release_intent_commit
        if: steps.release_intent.outputs.intent_modified == 'true'
        shell: bash
        run: |
          set -euo pipefail
          INTENT_FILE="${{ steps.release_intent.outputs.intent_file }}"
          if [ -z "${INTENT_FILE}" ] || [ ! -f "${INTENT_FILE}" ]; then
            echo "release-tag intent file missing; nothing to commit"
            echo "committed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "add release-tag intent" -- "${INTENT_FILE}"
          echo "committed=true" >> "$GITHUB_OUTPUT"
      -
        name: Add externpro .gitignore
        id: gitignore
        shell: bash
        run: |
          set -euo pipefail
          touch .gitignore
          required_lines=(
            "# externpro"
            ".env"
            "_bld*/"
            "docker-compose.override.yml"
          )
          for line in "${required_lines[@]}"; do
            if grep -Fxq -- "$line" .gitignore; then
              echo "gitignore already contains: $line"
            else
              echo "adding to gitignore: $line"
              printf '%s\n' "$line" >> .gitignore
            fi
          done
          git add .gitignore
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "gitignore: add externpro ignores" -- .gitignore
          echo "committed=true" >> "$GITHUB_OUTPUT"
      -
        name: Detect patch series
        id: patches
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          patches=(patches/*.patch)
          if [ -d patches ] && [ "${#patches[@]}" -gt 0 ]; then
            echo "Found ${#patches[@]} patch(es) under patches/"
            echo "present=true" >> "$GITHUB_OUTPUT"
            echo "patch_count=${#patches[@]}" >> "$GITHUB_OUTPUT"
          else
            echo "No patches/*.patch found"
            echo "present=false" >> "$GITHUB_OUTPUT"
            echo "patch_count=0" >> "$GITHUB_OUTPUT"
          fi
      -
        name: Apply patches
        if: steps.patches.outputs.present == 'true'
        uses: ./.devcontainer/.github/actions/git-am-patches
        with:
          patch_dir: patches
      -
        name: GHCR access
        id: ghcr
        uses: ./.devcontainer/.github/actions/ghcr-access
        with:
          build_container: ${{ env.XPRO_BUILD_CONTAINER }}
          automation_token: ${{ secrets.automation_token }}
      -
        name: Configure and snapshot dependency artifacts
        id: deps
        uses: ./.devcontainer/.github/actions/externpro-deps-configure
        with:
          submodule_path: ${{ steps.validate.outputs.submodule_path }}
          build_container: ${{ env.XPRO_BUILD_CONTAINER }}
          automation_token: ${{ secrets.automation_token }}
      -
        name: Commit dependency updates
        id: dependency_commit
        shell: bash
        run: |
          set -euo pipefail
          FILES="${{ steps.deps.outputs.dependency_files }}"
          FILES=$(printf '%s\n' "$FILES" | sed '/^$/d' | tr '\n' ' ')
          if [ -z "$FILES" ]; then
            echo "No dependency changes staged"
            echo "committed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "dependency updates" -- $FILES
          echo "committed=true" >> "$GITHUB_OUTPUT"
      -
        name: Commit externpro submodule pointer update
        id: submodule_pointer_commit
        if: ${{ steps.deps.outputs.submodule_dependency_commit == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          SUBMODULE_PATH="${{ steps.validate.outputs.submodule_path }}"
          git add "${SUBMODULE_PATH}"
          if git diff --cached --quiet -- "${SUBMODULE_PATH}"; then
            echo "No submodule pointer update staged"
            echo "committed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "externpro dependency updates" -- "${SUBMODULE_PATH}"
          echo "committed=true" >> "$GITHUB_OUTPUT"
      -
        name: Determine if PR is needed
        id: pr_needed
        run: |
          set -euo pipefail
          BASE_BRANCH="${{ github.event.repository.default_branch }}"
          git fetch origin "$BASE_BRANCH"
          COMMITS_AHEAD=$(git rev-list --count "origin/${BASE_BRANCH}..HEAD")
          if [ "$COMMITS_AHEAD" -eq 0 ]; then
            echo "No commits ahead of $BASE_BRANCH; skipping PR"
            echo "pr_needed=false" >> $GITHUB_OUTPUT
          else
            echo "Commits ahead of $BASE_BRANCH: $COMMITS_AHEAD"
            echo "pr_needed=true" >> $GITHUB_OUTPUT
          fi
      -
        name: Push branch
        shell: bash
        if: steps.pr_needed.outputs.pr_needed == 'true'
        env:
          TOKEN: ${{ secrets.automation_token }}
        run: |
          set -euo pipefail
          TOKEN=$(printf '%s' "${TOKEN}" | tr -d '\r\n' | xargs)
          if [ -z "${TOKEN}" ]; then
            echo "Error: automation_token is required" >&2
            exit 1
          fi
          git config --unset-all http.https://github.com/.extraheader || true
          git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git -c http.extraheader= push --set-upstream origin "${{ steps.branch.outputs.branch_name }}"
      -
        name: Ensure labels exist
        if: steps.pr_needed.outputs.pr_needed == 'true'
        uses: ./.devcontainer/.github/actions/labels-mgmt
        env:
          GH_TOKEN: ${{ secrets.automation_token || github.token }}
        with:
          cleanup_legacy_labels: ""
      -
        name: Create Pull Request
        id: create_pr
        if: steps.pr_needed.outputs.pr_needed == 'true'
        run: |
          set -euo pipefail
          GH_TOKEN="${{ secrets.automation_token }}"
          if [ -z "${GH_TOKEN}" ]; then
            GH_TOKEN="${{ github.token }}"
          fi
          export GH_TOKEN
          GH_RETRY=(bash .devcontainer/.github/actions/gh-retry/gh-retry.sh)
          BASE_BRANCH="${{ github.event.repository.default_branch }}"
          HEAD_BRANCH="${{ steps.branch.outputs.branch_name }}"
          export HEAD_BRANCH
          TITLE="Init externpro"
          BODY_FILE="/tmp/pr-body.md"
          : > "$BODY_FILE"
          echo "## Summary" >> "$BODY_FILE"
          echo >> "$BODY_FILE"
          echo "Initialize externpro integration" >> "$BODY_FILE"
          echo >> "$BODY_FILE"
          echo "## Changes" >> "$BODY_FILE"
          echo >> "$BODY_FILE"
          DOCKER_COMPOSE_COMMITTED="${{ steps.docker_compose.outputs.committed }}"
          CMAKE_PRESETS_COMMITTED="${{ steps.cmake_presets.outputs.committed }}"
          GHA_WORKFLOWS_COMMITTED="${{ steps.gha_workflows.outputs.committed }}"
          RELEASE_INTENT_CREATED="${{ steps.release_intent.outputs.intent_created }}"
          RELEASE_INTENT_TAG="${{ steps.release_intent.outputs.intent_tag }}"
          GITIGNORE_COMMITTED="${{ steps.gitignore.outputs.committed }}"
          DEPENDENCY_UPDATED="${{ steps.deps.outputs.dependency_updated }}"
          DEPENDENCY_FILES="${{ steps.deps.outputs.dependency_files }}"
          SUBMODULE_DEP_COMMIT="${{ steps.deps.outputs.submodule_dependency_commit }}"
          SUBMODULE_DEP_PUSH_REF="${{ steps.deps.outputs.submodule_dependency_push_ref }}"
          PATCHES_PRESENT="${{ steps.patches.outputs.present }}"
          PATCH_COUNT="${{ steps.patches.outputs.patch_count }}"
          if [ "$DOCKER_COMPOSE_COMMITTED" = "true" ]; then
            echo "- Add docker-compose links" >> "$BODY_FILE"
          fi
          if [ "$CMAKE_PRESETS_COMMITTED" = "true" ]; then
            echo "- Add CMakePresets" >> "$BODY_FILE"
          fi
          if [ "$GHA_WORKFLOWS_COMMITTED" = "true" ]; then
            echo "- Add GitHub Actions workflows" >> "$BODY_FILE"
          fi
          if [ "${{ steps.release_intent.outputs.intent_modified }}" = "true" ]; then
            if [ "${{ steps.release_intent.outputs.intent_created }}" = "true" ]; then
              echo "- Created \`.github/release-tag.json\` (tag: \`${RELEASE_INTENT_TAG}\`)" >> "$BODY_FILE"
            else
              echo "- Updated \`.github/release-tag.json\` (tag: \`${RELEASE_INTENT_TAG}\`)" >> "$BODY_FILE"
            fi
            echo "  - Optional: add the \"release:tag\" label to trigger tagging, release builds, and draft release notes" >> "$BODY_FILE"
          fi
          if [ "$GITIGNORE_COMMITTED" = "true" ]; then
            echo "- Add externpro ignores to .gitignore" >> "$BODY_FILE"
          fi
          if [ "$PATCHES_PRESENT" = "true" ]; then
            echo "- Patch series detected and applied (${PATCH_COUNT} patch(es))" >> "$BODY_FILE"
          else
            echo "- No patch series detected" >> "$BODY_FILE"
          fi
          if [ "$DEPENDENCY_UPDATED" = "true" ]; then
            echo "- Updated dependency files" >> "$BODY_FILE"
            if [ -n "$DEPENDENCY_FILES" ]; then
              echo "  - Files:" >> "$BODY_FILE"
              while IFS= read -r f; do
                [ -n "$f" ] && echo "    - \`$f\`" >> "$BODY_FILE"
              done < <(printf '%s\n' "$DEPENDENCY_FILES")
            fi
          fi
          if [ "$SUBMODULE_DEP_COMMIT" = "true" ]; then
            echo "- Updated externpro submodule dependency artifacts (pushed to \`${SUBMODULE_DEP_PUSH_REF}\`)" >> "$BODY_FILE"
          fi
          echo >> "$BODY_FILE"
          echo "---" >> "$BODY_FILE"
          echo >> "$BODY_FILE"
          echo "*This PR was created automatically by GitHub Actions*" >> "$BODY_FILE"
          if "${GH_RETRY[@]}" gh pr view "$HEAD_BRANCH" --json url --jq .url >/dev/null 2>&1; then
            PR_URL=$("${GH_RETRY[@]}" gh pr view "$HEAD_BRANCH" --json url --jq .url)
            echo "PR already exists for $HEAD_BRANCH: $PR_URL"
          else
            PR_URL=$("${GH_RETRY[@]}" gh pr create \
            --base "$BASE_BRANCH" \
            --head "$HEAD_BRANCH" \
            --title "$TITLE" \
            --body-file "$BODY_FILE")
            echo "Created PR: $PR_URL"
          fi
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          "${GH_RETRY[@]}" gh pr edit "$PR_URL" --add-label "dependencies" >/dev/null 2>&1 || echo "Label 'dependencies' not found; skipping"
          "${GH_RETRY[@]}" gh pr edit "$PR_URL" --add-label "xpinit" >/dev/null 2>&1 || echo "Label 'xpinit' not found; skipping"
      -
        name: Close superseded PRs
        if: steps.pr_needed.outputs.pr_needed == 'true'
        uses: ./.devcontainer/.github/actions/pr-close-superseded
        env:
          GH_TOKEN: ${{ secrets.automation_token || github.token }}
        with:
          head_branch_prefix: xpinit-
          keep_head_branch: ${{ steps.branch.outputs.branch_name }}
          label_name: xpinit
          pr_url: ${{ steps.create_pr.outputs.pr_url }}
          delete_branches: "true"
