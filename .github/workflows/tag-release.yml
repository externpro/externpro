name: Tag Release
on:
  workflow_call:
    inputs:
      merge_sha:
        required: true
        type: string
      pr_number:
        required: true
        type: number
    secrets:
      automation_token:
        description: 'Optional token used for automation (tag push). If not set, uses GITHUB_TOKEN (note: GITHUB_TOKEN pushes do not trigger other workflows).'
        required: false
jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      -
        name: Checkout merge commit
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.merge_sha }}
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.automation_token || github.token }}
      -
        name: Configure Git
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      -
        name: Validate release intent
        id: intent
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f .github/release-tag.json ]; then
            echo "intent_missing=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          TAG=$(python3 -c 'import json; print((json.load(open(".github/release-tag.json","r",encoding="utf-8")).get("tag") or "").strip())')
          MESSAGE=$(python3 -c 'import json; print((json.load(open(".github/release-tag.json","r",encoding="utf-8")).get("message") or "").rstrip("\n"))')
          if [ -z "$TAG" ]; then
            echo "release-tag.json missing 'tag'" >&2
            exit 1
          fi
          if [ -z "$MESSAGE" ]; then
            echo "release-tag.json missing 'message'" >&2
            exit 1
          fi
          if ! [[ "$TAG" =~ ^(xpv|v)[0-9A-Za-z][0-9A-Za-z._-]*$ ]]; then
            echo "Invalid tag format: $TAG" >&2
            exit 1
          fi
          if [[ "$TAG" =~ ^v[0-9A-Za-z] ]]; then
            echo "WARNING: legacy 'v' tag prefix detected; prefer 'xpv' for new externpro tags" >&2
          fi
          echo "intent_missing=false" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          printf 'message<<EOF\n%s\nEOF\n' "$MESSAGE" >> $GITHUB_OUTPUT
      -
        name: Comment on PR (missing release intent)
        if: ${{ steps.intent.outputs.intent_missing == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              'Missing `.github/release-tag.json` in the merge commit.',
              '',
              'To enable tagging on merge, add this file to the PR:',
              '',
              '```json',
              '{',
              '  "tag": "xpv11.2.0.8",',
              '  "message": "xpro version 11.2.0.8 tag"',
              '}',
              '```',
              '',
              'Then ensure the PR has the `release:tag` label before merging into `xpro`.'
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number('${{ inputs.pr_number }}'),
              body,
            });
      -
        name: Fail (missing release intent)
        if: ${{ steps.intent.outputs.intent_missing == 'true' }}
        shell: bash
        run: exit 1
      -
        name: Create and push tag
        shell: bash
        env:
          TAG: ${{ steps.intent.outputs.tag }}
          MESSAGE: ${{ steps.intent.outputs.message }}
        run: |
          set -euo pipefail
          git fetch --tags --force
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "Tag already exists: $TAG" >&2
            exit 1
          fi
          git tag -a "$TAG" "${{ inputs.merge_sha }}" -m "$MESSAGE"
          git push origin "refs/tags/$TAG"
